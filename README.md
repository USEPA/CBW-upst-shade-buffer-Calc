# CBW-upst-shade-buffer-Calc

This project details the approach and provides the R code for averaging effective shade for various upstream distance and travel time buffers with the Chesapeake Bay Watershed (CBW) as an example. Estimates of effective shade from riparian buffers can be used for the development of regional stream temperature models built from the National Hydrography Dataset Plus High-Resolution (NHDPlusHR) flowline network. This project was designed as a post-processing step that utilizes the output of the dmap-Rshade (https://github.com/USEPA/dmap-RShade) and CBW-cont-stream-temp-QC (https://github.com/USEPA/CBW-cont-stream-temp-QC) programs to calculate average effective shade for different upstream distance and travel time riparian buffers associated with stream water temperature monitoring stations and/or prediction locations snapped to the NHDPlusHR flowline network. Shade points for watershed tributaries and mainstems were genereated separately using dmap-Rshade based on calculations from Chen et al. (1998).

The main branch of this repository includes a R Markdown file with script that was used to generate the final average shade buffer dataset for the CBW and only an example dataset (test_datasets.RData). The example dataset was provided to allow the user to more efficiently test the script without the need to download large input files. The original inputs files, which include the output generated by dmap-RShade for the CBW for the months of July, August, and September, the coordinates/shapefile associated with 50m-interval flowline shade points, and the results generated by this script can be found at [insert link to Zenodo data repository]. The original monitoring station information (input) shapefile is stored separately at [insert link to Zenodo data repository]. A R Markdown .html file is provided in the repository for easier viewership. 

The R script is organized into 3 main sections.
1) Setup. Includes the installation and loading of R libraries required to run the script. This section also includes code to download, import, and organize the NHDPlusHR database for the CBW, site and/or prediction information files, the output of RShade for July, August, and September, and the coordinates that accompany the shade points.
2) NHDPlus High Resolution Indexing. Includes script to index monitoring station/prediction points and shade points to the NHDPlusHR flowline network, generating nhdplusids and "frommeas" and "tomeas" reach estimates for each site and shade point. The index is then used to estimate downstream travel times similar to the pathlength metric for distance.
3) Upstream Effective Shade. Estimates distance and travel times (as "the fish swims") for all shade points upstream of individual site/prediction points. A function is created that will take the average of effective shade values for upstream tributary and mainstem shade points associated with various distance and travel time buffer thresholds (e.g., 1-10km and 1-1000hrs). The function can then be applied to all site/prediction points using parallel processing.

Wondering how to use the GitHub and Zenodo repositories?
 
- If the user wishes to use the average effective shade values for the distance and water travel time buffers upstream of monitoring sites within the Chesapeake Bay Watershed (CBW), then they can simply download these files from the Zenodo repository.
- The GitHub repository enables the user to run through the script to estimate effective shade for various upstream distance and water travel time buffers from stream temperature monitoring sites snapped to the CBW NHDPlusHR flowline network. To do so, the user simply needs to load in the example dataset and run through the chunks starting at Line 187. Note, the user will not be able to run through the script prior to Line 187 with the example datasets. The example datasets were provided only to test functions to generate average shade buffer values in the "NHDPlus High Resolution Indexing" and "Upstream Effective Shade" sections.
- If desired, the user can make modifications to the script and use the example dataset to test their modifications.
- The user can apply their own generated shade values (https://github.com/USEPA/dmap-RShade) and site data. In this case, the user will need to ensure that the column name, organization, and formats are the same as the example datasets. If shade data is generated by a separate program/package, there may be some inconsistencies that the user should monitor as they adapt the code to their dataset.
- Should the user wish to generate the results in the Zenodo repository and test the GitHub code in its entirety, they can do so by downloading the "data" folder in the Zenodo repository and replace the "data" folder in the GitHub main branch. The user can then run through the script from top to bottom. Be aware that the entire chunk starting on Line 189 needs to be commented out to avoid loading the example datasets on top of those generated by the script. Folder naming and organization should be kept in tact, otherwise users may need to set a new working directory.
- Note, several places of the code leverage parallel processing that assign multiple cores to run the functions more efficiently. The number of assigned cores may need to be modified by the user. 


Questions about code can be directed to:

Craig Connolly
connolly.craig@epa.gov

Naomi Detenbeck
detenbeck.naomi@epa.gov

## References

Chen, Y.D., Carsel, R.F., McCutcheon, S.C., and Nutter, W.L. (1998). "Stream temperature simulation of forested riparian areas: I. watershed-scale model development", Journal of Environmental Engineering. April 1998. pp 304-315.

Chen, Y.D., Carsel, R.F., McCutcheon, S.C., and Nutter, W.L. (1998). "Stream temperature simulation of forested riparian areas: II. model application", Journal of Environmental Engineering. April 1998. pp 316-328.

## Credits
The Agency has unlimited rights to all custom-developed code produced. All comments expressed in this source code are the author's and do not necessarily reflect the policies and views of US EPA.

## Disclaimer
The United States Environmental Protection Agency (EPA) GitHub project code is provided on an "as is" basis and the user assumes responsibility for its use. EPA has relinquished control of the information and no longer has responsibility to protect the integrity, confidentiality, or availability of the information. Any reference to specific commercial products, processes, or services by service mark, trademark, manufacturer, or otherwise, does not constitute or imply their endorsement, recommendation or favoring by EPA. The EPA seal and logo shall not be used in any manner to imply endorsement of any commercial product or activity by EPA or the United States Government. 
