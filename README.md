# CBW-upst-shade-buffer-Calc

This project details the approach and provides the R code for generating upstream aggregations of effective shade across various upstream distance and travel time buffers for the Chesapeake Bay Watershed (CBW). Estimates of effective shade can then be used for the development of a regional stream temperature model based on the National Hydrography Dataset Plus High-Resolution (NHDPlusHR) flowline network. This project is a post-processing step that uses the output of the dmap-Rshade (https://github.com/USEPA/dmap-RShade) and CBW-cont-stream-temp-QC (https://github.com/USEPA/CBW-cont-stream-temp-QC) programs to calculate average effective shade for different distance and travel time "riparian" buffers that are upstream of monitoring stations and/or prediction locations snapped to the NHDPlusHR flowline network.

The main branch of this repository includes the code that was used to generate the final integrated shade buffer datasets for the CBW and only an example dataset (test_datasets.RData), which can be used to efficiently run through the script. Output files from dmap-RShade for the CBW for July, August, and September and the results generated by this script can be found here [insert link to Zenodo data repository]. The monitoring station information shapefile is stored separately at [insert link to Zenodo data repository]. A R Markdown .html file is provided for easier viewership. 

The R script is organized into 3 main sections.
1) Setup. Includes the installation and loading of R libraries required to run the script. This section also includes scripts to download, import, and organize the NHDPlusHR database for the CBW, site and/or prediction information files, the output of RShade for July, August, and September, and the coordinates that accompany the shade points.
2) NHDPlus High Resolution Indexing. Includes script to index monitoring station/prediction points and shade points to the NHDPlusHR flowline network, generating nhdplusids and frommeas and tomeas estimates for each site and shade point. The index is then used to estimate downstream travel times similar to the pathlength metric for distance.
3) Upstream Effective Shade. Estimates distance and travel times (as "the fish swims") for all shade points upstream of individual site/prediction points. A function is created that will take an average of effective shade values for upstream shade points for various distance and travel time buffers. The function can then be applied to all site/prediction points using parallel processing.


Questions about code can be directed to:

Craig Connolly
connolly.craig@epa.gov

Naomi Detenbeck
detenbeck.naomi@epa.gov

## Credits
The Agency has unlimited rights to all custom-developed code produced. All comments expressed in this source code are the author's and do not necessarily reflect the policies and views of US EPA.

## Disclaimer
The United States Environmental Protection Agency (EPA) GitHub project code is provided on an "as is" basis and the user assumes responsibility for its use. EPA has relinquished control of the information and no longer has responsibility to protect the integrity, confidentiality, or availability of the information. Any reference to specific commercial products, processes, or services by service mark, trademark, manufacturer, or otherwise, does not constitute or imply their endorsement, recommendation or favoring by EPA. The EPA seal and logo shall not be used in any manner to imply endorsement of any commercial product or activity by EPA or the United States Government. 
